#!/usr/bin/env bash

ssh_cmd() {
  local rc bootstrap

  rc="
  [[ -r /etc/profile ]] && source /etc/profile
  if [[ -r ~/.bash_profile ]]; then
    source ~/.bash_profile
  elif [[ -r ~/.bash_login ]]; then
    source ~/.bash_login
  elif [[ -r ~/.profile ]]; then
    source ~/.profile
  fi
  export PATH=\$PATH:\$SSHHOME
  source \$SSHHOME/.sshrc"

  bootstrap="
  # Copy .sshrc and .sshrc.d; clean up when leaving
  export SSHHOME=\$(mktemp -d -t .$(whoami).sshrc.XXXXXXXX)
  export SSHRCCLEANUP=\$SSHHOME
  trap \"rm -rf \$SSHRCCLEANUP; exit\" 0
  echo $'$(tar c -h -C "${SSHHOME}" ${files:=$1} | openssl enc -base64)' \
    | openssl enc -base64 -d \
    | tar mx -C \$SSHHOME

  # Copy sshrc binary, so we can run sshrc again from the new host
  echo $'$(openssl enc -base64 < "$0")' \
    | openssl enc -base64 -d > \$SSHHOME/sshrc
  chmod +x \$SSHHOME/sshrc

  # Copy bootstrap rcfile
  echo $'${rc}' > \$SSHHOME/sshrc.rc

  # Create a wrapper around bash and use that as the shell
  echo 'bash --rcfile \$SSHHOME/sshrc.rc \"\$@\"' > \$SSHHOME/sshrcsh
  chmod +x \$SSHHOME/sshrcsh
  SHELL=\$SSHHOME/sshrcsh
  [ -e /etc/motd ] && cat /etc/motd
  \$SSHHOME/sshrcsh"

  echo "
  # Bail if openssl isn't installed on the remote host
  $(declare -f encode)
  if [ ! \$(command -v encode) ]; then
    echo >&2 \"Error: sshrc requires openssl or base64 to be installed \" \\
      \"on the server\"
    exit 1
  fi

  # Compress bootstrap script for faster ssh connection and reduced risk of
  # ssh command being rejected by the server
  eval \"\$(echo $'$(echo "${bootstrap}" | gzip -c | openssl enc -base64)' \
    | openssl enc -base64 -d \
    | gzip -d)\""
}

encode() {
  if  [ "$(command -v openssl)" ]; then openssl enc -base64 "$@"
  elif [ "$(command -v base64)" ]; then base64 "$@"
  fi
}

check_size() {
  local LC_ALL=C
  size="${#1}"
  if [ "${size}" -gt $(( 65 * 1024 )) ]; then
    echo >&2 "Error: the compressed size of .sshrc, .sshrc.d, and the sshrc" \
      "script must be less than 64kb"
    echo "Current size: ${size} bytes"
    exit 1
  fi
}

main() {
  local files cmd size
  [[ $# -lt 1 ]] && return "$(ssh)"

  if [[ ! $(command -v encode) ]]; then
    echo >&2 "Error: sshrc requires openssl or base64 to be installed locally"
    exit 1
  fi

  if [[ -z "${SSHHOME}" ]]; then
    for SSHHOME in $PWD $HOME; do
      [[ -f "${SSHHOME}/.sshrc" ]] && break
    done
  fi

  if [[ -f "${SSHHOME}/.sshrc" ]]; then
    files="${files} .sshrc"
  else
    echo >&2 "Error: could not find .sshrc in current directory or ${HOME}"
    exit 1
  fi
  [[ -d "${SSHHOME}/.sshrc.d" ]] && files="${files} .sshrc.d"

  cmd="$(ssh_cmd "${files}")"
  check_size "${cmd}"

  ssh -t "$@" "${cmd}"
}

main "$@"
